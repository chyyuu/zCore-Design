# 硬件抽象层

zCore 在设计时就已经考虑到了上下层兼容的问题。整个操作系统在编写的过程中几乎不依赖硬件相关的汇编语言，而是通过硬件抽象层与底层物理硬件（裸机）直接打交道，或以LibOS的形式与宿主操作系统（HostOS）环境进行交互。这一层实现的接口在 kernel_hal 模块中。kernel_hal 中定义了操作系统需要硬件提供的接口。定义方式与传统方式不同，是先用 unimplemented 宏创建一个空的实现，然后将函数标记为 weak 链接形式。如果在其它地方有同名函数的实现存在，则被标记为 weak 链接的函数会被覆盖。

与裸机适配的具体底层接口代码实现在 kernel_hal_bare 模块，这是主要的硬件相关的代码部分，因此也是移植过程中需要重点关注的点。注意到 kernel_hal_bare 模块依赖了 trapframe 模块，这个模块主要用于处理解决中断相关的问题，也是与硬件平台架构相关的。

与传统操作系统只能运行在硬件上不同，zCore 也可以作为一个普通的用户程序运行在 Linux 或 macOS 的用户态。这种运行方式被称为 LibOS 或 User-Mode OS 。这个特性同样得益于 kernel_hal 的统一抽象接口的存在。将 zCore 作为普通用户程序运行的核心代码位于 kernel_hal_unix 。由于 zCore 只依赖 kernel_hal 模块中的接口，因此可以利用宿主操作系统的系统调用实现这部分接口。如果zCore能作为用户程序运行，就可以方便地使用 GDB 和 IDE集成开发环境进行调试。除此之外，还可以运行单元测试，统计测试覆盖率等。

